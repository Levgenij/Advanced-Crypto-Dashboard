<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced Crypto Dashboard</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #000;
            color: #fff;
            font-family: sans-serif;
        }

        #scaleContainer {
            transform-origin: top left;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 5px 10px;
            background: #222;
            align-items: center;
            font-size: 12px;
        }

        .symbol-list {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }

        .symbol-tag {
            background: #444;
            color: #fff;
            padding: 2px 5px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
        }

        .grid-wrapper {
            flex: 1;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .grid {
            display: grid;
            gap: 0;
            width: 100%;
            height: 100%;
        }

        .widget-container {
            width: 100%;
            height: 100%;
        }

        .paginator {
            display: block;
            position: fixed;
            bottom: 0;
            text-align: center;
            width: 100%;
            justify-content: center;
            align-items: center;
            gap: 5px;
            padding: 5px;
            background: #222;
        }

        input, button, select {
            padding: 2px 5px;
            border: none;
            background: #444;
            color: #fff;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }

        button.active {
            background: #28a745 !important;
            color: #fff !important;
        }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="text" id="symbolInput" placeholder="BTCUSDT" onkeydown="handleInputKeydown(event)"/>
    <button onclick="addSymbol()">Add</button>
    <button onclick="clearSymbols()">Clear</button>
    <button id="btnMACD" onclick="toggleMACD()">MACD</button>
    <button id="btnSideToolbar" onclick="toggleSideToolbar()">Side</button>
    <button id="btnTopToolbar" onclick="toggleTopToolbar()">Top</button>
    <label>Interval:</label>
    <select id="intervalSelect" onchange="changeInterval()">
        <option value="1">1m</option>
        <option value="3">3m</option>
        <option value="5">5m</option>
        <option value="15">15m</option>
        <option value="30">30m</option>
        <option value="60">1h</option>
        <option value="240">4h</option>
        <option value="D">1D</option>
    </select>
    <label>Cols:</label>
    <input type="number" id="colsInput" min="1" value="2" style="width:40px" onchange="renderWidgets()">
    <label>Rows:</label>
    <input type="number" id="rowsInput" min="1" value="2" style="width:40px" onchange="renderWidgets()">
    <button onclick="zoomOut()">-</button>
    <button onclick="zoomIn()">+</button>

    <div class="symbol-list" id="symbolList"></div>
</div>

<div id="scaleContainer">
    <div class="grid-wrapper">
        <div id="widgetGrid" class="grid"></div>
    </div>
</div>

<div id="paginator" class="paginator" style="display:none;">
    <button onclick="prevPage()">&lt;</button>
    <span id="pageInfo">Page 1</span>
    <button onclick="nextPage()">&gt;</button>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
    let symbols = JSON.parse(localStorage.getItem('cryptoSymbols')) || ["BTCUSDT", "ETHUSDT", "ETHUSDT", "SOLUSDT", "DOGEUSDT"];
    let showMACD = JSON.parse(localStorage.getItem('showMACD')) ?? true;
    let showSideToolbar = JSON.parse(localStorage.getItem('showSideToolbar')) ?? true;
    let showTopToolbar = JSON.parse(localStorage.getItem('showTopToolbar')) ?? true;
    let selectedInterval = localStorage.getItem('cryptoInterval') || "15";
    let zoomLevel = parseFloat(localStorage.getItem('zoomLevel')) || 1;
    let currentPage = 0;


    const scaleContainer = document.getElementById('scaleContainer');
    const grid = document.getElementById('widgetGrid');
    const symbolList = document.getElementById('symbolList');
    const paginator = document.getElementById('paginator');
    const pageInfo = document.getElementById('pageInfo');
    const intervalSelect = document.getElementById('intervalSelect');
    const btnMACD = document.getElementById('btnMACD');
    const btnSideToolbar = document.getElementById('btnSideToolbar');
    const btnTopToolbar = document.getElementById('btnTopToolbar');
    const colsInput = document.getElementById('colsInput');
    const rowsInput = document.getElementById('rowsInput');

    intervalSelect.value = selectedInterval;

    function applyZoom() {
        scaleContainer.style.transform = `scale(${zoomLevel})`;
        scaleContainer.style.width = `${100 / zoomLevel}vw`;
        scaleContainer.style.height = `${100 / zoomLevel}vh`;
        localStorage.setItem('zoomLevel', zoomLevel);
    }

    function zoomIn() {
        zoomLevel = Math.min(2, zoomLevel + 0.1);
        applyZoom();
    }

    function zoomOut() {
        zoomLevel = Math.max(0.5, zoomLevel - 0.1);
        applyZoom();
    }

    function saveSettings() {
        localStorage.setItem('cryptoSymbols', JSON.stringify(symbols));
        localStorage.setItem('showMACD', JSON.stringify(showMACD));
        localStorage.setItem('showSideToolbar', JSON.stringify(showSideToolbar));
        localStorage.setItem('showTopToolbar', JSON.stringify(showTopToolbar));
        localStorage.setItem('cryptoInterval', selectedInterval);
    }

    function updateButtonStates() {
        btnMACD.classList.toggle('active', showMACD);
        btnSideToolbar.classList.toggle('active', showSideToolbar);
        btnTopToolbar.classList.toggle('active', showTopToolbar);
    }

    function renderSymbolList() {
        symbolList.innerHTML = '';
        symbols.forEach((s, index) => {
            const tag = document.createElement('div');
            tag.className = 'symbol-tag';
            tag.textContent = s;
            tag.onmouseenter = () => tag.classList.add('hovered');
            tag.onmouseleave = () => tag.classList.remove('hovered');
            tag.onwheel = (e) => {
                e.preventDefault();
                if (e.deltaY < 0) moveSymbolUp(index);
                else moveSymbolDown(index);
            };
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'Ã—';
            removeBtn.onclick = () => removeSymbol(index);
            tag.appendChild(removeBtn);
            symbolList.appendChild(tag);
        });
    }

    function renderWidgets() {
        grid.innerHTML = '';
        const cols = parseInt(colsInput.value);
        const rows = parseInt(rowsInput.value);
        const pageSize = cols * rows;
        const totalPages = Math.ceil(symbols.length / pageSize);

        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

        const pageSymbols = symbols.slice(currentPage * pageSize, (currentPage + 1) * pageSize);

        pageSymbols.forEach((s, index) => {
            const containerId = 'widget-' + index;
            const container = document.createElement('div');
            container.id = containerId;
            container.className = 'widget-container';
            grid.appendChild(container);

            new TradingView.widget({
                autosize: true,
                symbol: `BYBIT:${s}.P`,
                interval: selectedInterval,
                timezone: "Etc/UTC",
                theme: "dark",
                style: "1",
                locale: "en",
                hide_side_toolbar: !showSideToolbar,
                hide_top_toolbar: !showTopToolbar,
                allow_symbol_change: true,
                save_image: false,
                studies: showMACD ? ["STD;MACD"] : [],
                hide_volume: true,
                container_id: containerId,
                support_host: "https://www.tradingview.com"
            });
        });

        paginator.style.display = totalPages > 1 ? 'flex' : 'none';
        pageInfo.textContent = `Page ${currentPage + 1} / ${totalPages}`;
        renderSymbolList();
        updateButtonStates();
        saveSettings();
        applyZoom();
    }

    function moveSymbolUp(index) {
        if (index > 0) {
            [symbols[index], symbols[index - 1]] = [symbols[index - 1], symbols[index]];
            renderWidgets();
        }
    }

    function moveSymbolDown(index) {
        if (index < symbols.length - 1) {
            [symbols[index], symbols[index + 1]] = [symbols[index + 1], symbols[index]];
            renderWidgets();
        }
    }

    function prevPage() {
        if (currentPage > 0) {
            currentPage--;
            renderWidgets();
        }
    }

    function nextPage() {
        const cols = parseInt(colsInput.value);
        const rows = parseInt(rowsInput.value);
        const pageSize = cols * rows;
        const totalPages = Math.ceil(symbols.length / pageSize);
        if (currentPage < totalPages - 1) {
            currentPage++;
            renderWidgets();
        }
    }

    function addSymbol() {
        const input = document.getElementById('symbolInput');
        const newSymbol = input.value.trim().toUpperCase();
        if (newSymbol && !symbols.includes(newSymbol)) {
            symbols.push(newSymbol);
            renderWidgets();
        }
        input.value = '';
    }

    function handleInputKeydown(event) {
        if (event.key === 'Enter') addSymbol();
    }

    function removeSymbol(index) {
        symbols.splice(index, 1);
        renderWidgets();
    }

    function clearSymbols() {
        if (confirm('Are you sure you want to remove all symbols?')) {
            symbols = [];
            renderWidgets();
        }
    }

    function toggleMACD() {
        showMACD = !showMACD;
        renderWidgets();
    }

    function toggleSideToolbar() {
        showSideToolbar = !showSideToolbar;
        renderWidgets();
    }

    function toggleTopToolbar() {
        showTopToolbar = !showTopToolbar;
        renderWidgets();
    }

    function changeInterval() {
        selectedInterval = intervalSelect.value;
        renderWidgets();
    }

    renderWidgets();
</script>
</body>
</html>
